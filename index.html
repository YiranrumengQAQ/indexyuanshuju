<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›¾ç‰‡è§†é¢‘å…ƒæ•°æ®æ¸…é™¤å·¥å…·</title>
    <style>
        :root {
            --primary-green: #2d5016;
            --secondary-green: #3d6b25;
            --light-green: #5a8c37;
            --accent-green: #7fb069;
            --cream-white: #fffef7;
            --soft-cream: #faf8f0;
            --light-cream: #f5f3e8;
            --dark-text: #2d3319;
            --medium-text: #5a6143;
            --light-text: #8a8f7a;
            --danger-color: #d9534f;
            --danger-bg: #fef5f5;
            --warning-color: #f0ad4e;
            --warning-bg: #fef9f2;
            --success-color: #5cb85c;
            --success-bg: #f0f9f0;
            --shadow-sm: 0 2px 8px rgba(45, 80, 22, 0.08);
            --shadow-md: 0 4px 16px rgba(45, 80, 22, 0.12);
            --shadow-lg: 0 8px 32px rgba(45, 80, 22, 0.16);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, var(--light-green) 0%, var(--secondary-green) 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: 'ğŸŒ¿';
            position: fixed;
            font-size: 200px;
            opacity: 0.05;
            top: 10%;
            right: 10%;
            animation: float 20s ease-in-out infinite;
            pointer-events: none;
        }

        body::after {
            content: 'ğŸƒ';
            position: fixed;
            font-size: 150px;
            opacity: 0.05;
            bottom: 10%;
            left: 10%;
            animation: float 25s ease-in-out infinite reverse;
            pointer-events: none;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            33% { transform: translate(20px, -20px) rotate(5deg); }
            66% { transform: translate(-15px, 15px) rotate(-5deg); }
        }

        .container {
            background: var(--cream-white);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
            max-width: 1100px;
            width: 100%;
            padding: 50px;
            position: relative;
            z-index: 1;
            animation: slideUp 0.6s ease-out;
            border: 3px solid rgba(127, 176, 105, 0.2);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header {
            text-align: center;
            margin-bottom: 45px;
        }

        .header-icon {
            font-size: 4em;
            margin-bottom: 15px;
            display: inline-block;
            animation: bounce 2s ease-in-out infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .header h1 {
            color: var(--primary-green);
            font-size: 2.5em;
            margin-bottom: 12px;
            font-weight: 800;
        }

        .header p {
            color: var(--medium-text);
            font-size: 1.05em;
            font-weight: 500;
        }

        .upload-area {
            border: 3px dashed var(--accent-green);
            border-radius: var(--radius-lg);
            padding: 70px 30px;
            text-align: center;
            transition: var(--transition);
            cursor: pointer;
            background: var(--soft-cream);
            position: relative;
            overflow: hidden;
        }

        .upload-area::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--light-green), var(--accent-green));
            opacity: 0;
            transition: var(--transition);
        }

        .upload-area:hover {
            border-color: var(--secondary-green);
            background: var(--light-cream);
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
        }

        .upload-area:hover::before {
            opacity: 0.05;
        }

        .upload-area.dragover {
            border-color: var(--primary-green);
            background: rgba(127, 176, 105, 0.1);
            transform: scale(1.02);
            box-shadow: 0 0 0 4px rgba(127, 176, 105, 0.15);
        }

        .upload-content {
            position: relative;
            z-index: 1;
        }

        .upload-icon {
            font-size: 5em;
            margin-bottom: 20px;
            display: inline-block;
            transition: var(--transition);
        }

        .upload-area:hover .upload-icon {
            transform: scale(1.1) rotate(5deg);
        }

        .upload-text {
            color: var(--dark-text);
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .upload-hint {
            color: var(--light-text);
            font-size: 0.95em;
        }

        #fileInput {
            display: none;
        }

        .file-info {
            display: none;
            margin-top: 35px;
        }

        .file-info.active {
            display: block;
            animation: fadeInUp 0.5s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .preview-container {
            margin: 25px 0;
            text-align: center;
            background: var(--soft-cream);
            padding: 25px;
            border-radius: var(--radius-md);
            border: 2px solid rgba(127, 176, 105, 0.2);
        }

        .preview-image, .preview-video {
            max-width: 100%;
            max-height: 450px;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-md);
            transition: var(--transition);
        }

        .preview-image:hover, .preview-video:hover {
            transform: scale(1.02);
            box-shadow: var(--shadow-lg);
        }

        .file-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 18px;
            margin: 25px 0;
        }

        .detail-item {
            background: var(--cream-white);
            padding: 20px;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
            border: 2px solid transparent;
        }

        .detail-item:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
            border-color: rgba(127, 176, 105, 0.3);
        }

        .detail-label {
            color: var(--medium-text);
            font-size: 0.85em;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .detail-value {
            color: var(--dark-text);
            font-size: 1.15em;
            font-weight: 700;
            word-break: break-word;
        }

        .size-comparison {
            background: var(--light-cream);
            padding: 15px;
            border-radius: var(--radius-sm);
            margin-top: 10px;
            font-size: 0.9em;
            color: var(--medium-text);
        }

        .size-comparison.reduced {
            background: var(--success-bg);
            color: var(--success-color);
            font-weight: 600;
        }

        .metadata-section {
            margin: 30px 0;
            padding: 30px;
            background: var(--danger-bg);
            border-radius: var(--radius-md);
            border-left: 5px solid var(--danger-color);
            animation: fadeInUp 0.5s ease-out;
            box-shadow: var(--shadow-sm);
            position: relative;
        }

        .metadata-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .metadata-title {
            color: var(--danger-color);
            font-size: 1.4em;
            font-weight: 800;
        }

        .metadata-badge {
            background: var(--danger-color);
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 700;
            box-shadow: 0 2px 8px rgba(217, 83, 79, 0.3);
        }

        .metadata-toggle {
            margin-left: auto;
            background: transparent;
            border: 2px solid var(--danger-color);
            color: var(--danger-color);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .metadata-toggle:hover {
            background: var(--danger-color);
            color: white;
        }

        .metadata-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            max-height: 400px;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .metadata-list.collapsed {
            max-height: 200px;
        }

        .metadata-list.expanded {
            max-height: none;
        }

        .metadata-item {
            background: var(--cream-white);
            padding: 15px 18px;
            border-radius: var(--radius-sm);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
            gap: 10px;
        }

        .metadata-item:hover {
            transform: translateX(5px);
            box-shadow: var(--shadow-md);
        }

        .metadata-key {
            color: var(--medium-text);
            font-size: 0.9em;
            font-weight: 600;
        }

        .metadata-value {
            color: var(--dark-text);
            font-weight: 700;
            text-align: right;
            max-width: 60%;
            word-break: break-word;
            font-size: 0.95em;
            max-height: 3em;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .no-metadata {
            text-align: center;
            color: var(--success-color);
            padding: 25px;
            background: var(--success-bg);
            border-radius: var(--radius-sm);
            font-weight: 700;
            font-size: 1.1em;
            box-shadow: var(--shadow-sm);
        }

        .warning-box {
            background: var(--warning-bg);
            border-left: 5px solid var(--warning-color);
            padding: 20px 25px;
            border-radius: var(--radius-md);
            margin: 25px 0;
            display: flex;
            align-items: start;
            gap: 15px;
            box-shadow: var(--shadow-sm);
        }

        .warning-icon {
            font-size: 1.8em;
            flex-shrink: 0;
        }

        .warning-text {
            color: #8a5d0f;
            line-height: 1.7;
            font-weight: 500;
        }

        .warning-text strong {
            font-weight: 800;
        }

        .buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 18px;
            margin-top: 30px;
        }

        .btn {
            padding: 18px 35px;
            border: none;
            border-radius: var(--radius-md);
            font-size: 1.05em;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            text-transform: uppercase;
            letter-spacing: 0.8px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.4);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:active::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--secondary-green), var(--light-green));
            color: white;
            box-shadow: 0 4px 15px rgba(61, 107, 37, 0.4);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(61, 107, 37, 0.6);
        }

        .btn-secondary {
            background: var(--light-cream);
            color: var(--dark-text);
            box-shadow: var(--shadow-sm);
            border: 2px solid var(--accent-green);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--soft-cream);
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .status {
            margin-top: 25px;
            padding: 18px 25px;
            border-radius: var(--radius-md);
            text-align: center;
            font-weight: 600;
            display: none;
            font-size: 1.05em;
        }

        .status.success {
            background: var(--success-bg);
            color: #2d5016;
            border-left: 5px solid var(--success-color);
            display: block;
            animation: fadeInUp 0.5s ease;
        }

        .status.error {
            background: var(--danger-bg);
            color: #a94442;
            border-left: 5px solid var(--danger-color);
            display: block;
            animation: fadeInUp 0.5s ease;
        }

        .status.processing {
            background: #e8f4f8;
            color: #31708f;
            border-left: 5px solid #5bc0de;
            display: block;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-top: 35px;
            padding-top: 35px;
            border-top: 2px solid rgba(127, 176, 105, 0.2);
        }

        .feature-item {
            text-align: center;
            padding: 25px;
            border-radius: var(--radius-md);
            transition: var(--transition);
            background: var(--soft-cream);
            box-shadow: var(--shadow-sm);
            border: 2px solid transparent;
        }

        .feature-item:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-md);
            background: linear-gradient(135deg, var(--secondary-green), var(--light-green));
            border-color: var(--accent-green);
        }

        .feature-item:hover .feature-icon,
        .feature-item:hover .feature-title,
        .feature-item:hover .feature-desc {
            color: white;
        }

        .feature-icon {
            font-size: 3em;
            margin-bottom: 15px;
            display: inline-block;
            transition: var(--transition);
        }

        .feature-item:hover .feature-icon {
            transform: scale(1.2);
        }

        .feature-title {
            color: var(--primary-green);
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 1.1em;
            transition: var(--transition);
        }

        .feature-desc {
            color: var(--medium-text);
            font-size: 0.95em;
            line-height: 1.6;
            transition: var(--transition);
        }

        .loader {
            width: 50px;
            height: 50px;
            margin: 25px auto;
            position: relative;
            display: none;
        }

        .loader.active {
            display: block;
        }

        .loader::before,
        .loader::after {
            content: '';
            position: absolute;
            border-radius: 50%;
            animation: ripple 1.5s ease-out infinite;
        }

        .loader::before {
            width: 100%;
            height: 100%;
            border: 4px solid var(--secondary-green);
        }

        .loader::after {
            width: 100%;
            height: 100%;
            border: 4px solid var(--light-green);
            animation-delay: 0.5s;
        }

        @keyframes ripple {
            0% {
                transform: scale(0);
                opacity: 1;
            }
            100% {
                transform: scale(1.5);
                opacity: 0;
            }
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--light-cream);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 20px;
            display: none;
            border: 1px solid rgba(127, 176, 105, 0.2);
        }

        .progress-bar.active {
            display: block;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--secondary-green), var(--accent-green));
            width: 0%;
            transition: width 0.3s ease;
        }

        .captcha-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease;
        }

        .captcha-modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .captcha-content {
            background: var(--cream-white);
            padding: 25px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            max-width: 350px;
            width: 90%;
            animation: scaleIn 0.3s ease;
        }

        @keyframes scaleIn {
            from {
                transform: scale(0.9);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .captcha-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .captcha-title {
            color: var(--primary-green);
            font-size: 1.3em;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .captcha-subtitle {
            color: var(--medium-text);
            font-size: 0.9em;
        }

        .captcha-image-wrapper {
            text-align: center;
            margin: 20px 0;
            background: var(--soft-cream);
            padding: 15px;
            border-radius: var(--radius-md);
            border: 2px solid rgba(127, 176, 105, 0.2);
        }

        .captcha-image {
            max-width: 100%;
            height: auto;
            border-radius: var(--radius-sm);
            box-shadow: var(--shadow-sm);
            cursor: pointer;
            transition: var(--transition);
        }

        .captcha-image:hover {
            transform: scale(1.05);
        }

        .captcha-refresh {
            display: inline-block;
            margin-top: 10px;
            color: var(--light-green);
            font-size: 0.85em;
            cursor: pointer;
            text-decoration: underline;
        }

        .captcha-refresh:hover {
            color: var(--secondary-green);
        }

        .captcha-input-group {
            margin: 20px 0;
        }

        .captcha-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--accent-green);
            border-radius: var(--radius-sm);
            font-size: 1em;
            transition: var(--transition);
            background: var(--soft-cream);
        }

        .captcha-input:focus {
            outline: none;
            border-color: var(--secondary-green);
            box-shadow: 0 0 0 3px rgba(61, 107, 37, 0.1);
        }

        .captcha-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .captcha-btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .captcha-btn-primary {
            background: linear-gradient(135deg, var(--secondary-green), var(--light-green));
            color: white;
        }

        .captcha-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .captcha-btn-secondary {
            background: var(--light-cream);
            color: var(--dark-text);
            border: 2px solid var(--accent-green);
        }

        .captcha-btn-secondary:hover {
            background: var(--soft-cream);
        }

        .captcha-error {
            color: var(--danger-color);
            font-size: 0.85em;
            margin-top: 10px;
            display: none;
            text-align: center;
        }

        .captcha-error.active {
            display: block;
        }

        @media (max-width: 768px) {
            .container {
                padding: 30px 20px;
            }

            .header h1 {
                font-size: 2em;
            }

            .upload-area {
                padding: 50px 20px;
            }

            .metadata-list,
            .file-details,
            .buttons,
            .features {
                grid-template-columns: 1fr;
            }

            .captcha-content {
                max-width: 90%;
            }
        }

        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-icon">ğŸ—‘ï¸</div>
            <h1>å…ƒæ•°æ®æ¸…é™¤å·¥å…·</h1>
            <p>åˆ é™¤å›¾ç‰‡å’Œè§†é¢‘ä¸­çš„EXIFã€GPSå®šä½ç­‰å…ƒæ•°æ®ä¿¡æ¯</p>
        </div>

        <div class="upload-area" id="uploadArea">
            <div class="upload-content">
                <div class="upload-icon">ğŸ“</div>
                <div class="upload-text">æ‹–æ”¾æ–‡ä»¶åˆ°è¿™é‡Œæˆ–ç‚¹å‡»é€‰æ‹©</div>
                <div class="upload-hint">æ”¯æŒ JPG, PNG, GIF, WebP, MP4, WebM, MOV ç­‰æ ¼å¼</div>
            </div>
            <input type="file" id="fileInput" accept="image/*,video/*" multiple="false">
        </div>

        <div class="file-info" id="fileInfo">
            <div class="preview-container" id="previewContainer"></div>

            <div class="file-details" id="fileDetails"></div>

            <div id="metadataContainer"></div>

            <div class="progress-bar" id="progressBar">
                <div class="progress-fill" id="progressFill"></div>
            </div>

            <div class="buttons">
                <button class="btn btn-primary" id="processBtn">ğŸ”’ æ¸…é™¤å…ƒæ•°æ®</button>
                <button class="btn btn-secondary" id="downloadBtn" disabled>ğŸ’¾ ä¸‹è½½æ–‡ä»¶</button>
                <button class="btn btn-secondary" id="resetBtn">ğŸ”„ é‡æ–°é€‰æ‹©</button>
            </div>

            <div class="loader" id="loader"></div>
            <div class="status" id="status"></div>
        </div>

        <div class="features">
            <div class="feature-item">
                <div class="feature-icon">ğŸ”</div>
                <div class="feature-title">æœ¬åœ°å¤„ç†</div>
                <div class="feature-desc">æ‰€æœ‰æ“ä½œåœ¨æµè§ˆå™¨ä¸­å®Œæˆï¼Œæ–‡ä»¶ä¸ä¼šä¸Šä¼ åˆ°æœåŠ¡å™¨</div>
            </div>
            <div class="feature-item">
                <div class="feature-icon">ğŸ”</div>
                <div class="feature-title">å…ƒæ•°æ®æ£€æµ‹</div>
                <div class="feature-desc">è‡ªåŠ¨è¯†åˆ«EXIFã€GPSå®šä½ã€è®¾å¤‡ä¿¡æ¯ç­‰å…ƒæ•°æ®</div>
            </div>
            <div class="feature-item">
                <div class="feature-icon">âš¡</div>
                <div class="feature-title">æ™ºèƒ½å‹ç¼©</div>
                <div class="feature-desc">ä¿æŒåŸæ ¼å¼ï¼Œä¼˜åŒ–æ–‡ä»¶å¤§å°ï¼Œåˆ é™¤å…ƒæ•°æ®åä½“ç§¯æ›´å°</div>
            </div>
        </div>
    </div>

    <div class="captcha-modal" id="captchaModal">
        <div class="captcha-content">
            <div class="captcha-header">
                <div class="captcha-title">éªŒè¯ç </div>
                <div class="captcha-subtitle">è¯·è¾“å…¥å›¾ç‰‡ä¸­ç®—å¼çš„ç»“æœ</div>
            </div>
            <div class="captcha-image-wrapper">
                <img class="captcha-image" id="captchaImage" alt="éªŒè¯ç ">
                <div>
                    <span class="captcha-refresh" id="captchaRefresh">ğŸ”„ åˆ·æ–°éªŒè¯ç </span>
                </div>
            </div>
            <div class="captcha-input-group">
                <input type="text" class="captcha-input" id="captchaInput" placeholder="è¯·è¾“å…¥è®¡ç®—ç»“æœï¼ˆæ•°å­—ï¼‰" maxlength="10">
                <div class="captcha-error" id="captchaError">éªŒè¯ç é”™è¯¯ï¼Œè¯·é‡è¯•</div>
            </div>
            <div class="captcha-buttons">
                <button class="captcha-btn captcha-btn-primary" id="captchaSubmit">ç¡®è®¤</button>
                <button class="captcha-btn captcha-btn-secondary" id="captchaCancel">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
    <script>
        'use strict';

        const state = {
            currentFile: null,
            processedBlob: null,
            hasMetadata: false,
            captchaId: null,
            captchaVerified: false,
            originalSize: 0
        };

        const elements = {
            uploadArea: document.getElementById('uploadArea'),
            fileInput: document.getElementById('fileInput'),
            fileInfo: document.getElementById('fileInfo'),
            previewContainer: document.getElementById('previewContainer'),
            fileDetails: document.getElementById('fileDetails'),
            metadataContainer: document.getElementById('metadataContainer'),
            processBtn: document.getElementById('processBtn'),
            downloadBtn: document.getElementById('downloadBtn'),
            resetBtn: document.getElementById('resetBtn'),
            status: document.getElementById('status'),
            loader: document.getElementById('loader'),
            progressBar: document.getElementById('progressBar'),
            progressFill: document.getElementById('progressFill'),
            captchaModal: document.getElementById('captchaModal'),
            captchaImage: document.getElementById('captchaImage'),
            captchaInput: document.getElementById('captchaInput'),
            captchaError: document.getElementById('captchaError'),
            captchaSubmit: document.getElementById('captchaSubmit'),
            captchaCancel: document.getElementById('captchaCancel'),
            captchaRefresh: document.getElementById('captchaRefresh')
        };

        const metadataFields = {
            'Make': 'è®¾å¤‡åˆ¶é€ å•†',
            'Model': 'è®¾å¤‡å‹å·',
            'DateTime': 'æ‹æ‘„æ—¶é—´',
            'DateTimeOriginal': 'åŸå§‹æ—¥æœŸ',
            'DateTimeDigitized': 'æ•°å­—åŒ–æ—¥æœŸ',
            'GPSLatitude': 'GPSçº¬åº¦',
            'GPSLongitude': 'GPSç»åº¦',
            'GPSAltitude': 'GPSæµ·æ‹”',
            'Software': 'è½¯ä»¶ä¿¡æ¯',
            'Artist': 'ä½œè€…',
            'Copyright': 'ç‰ˆæƒä¿¡æ¯',
            'UserComment': 'ç”¨æˆ·æ³¨é‡Š',
            'ImageWidth': 'å›¾åƒå®½åº¦',
            'ImageHeight': 'å›¾åƒé«˜åº¦',
            'Orientation': 'æ–¹å‘',
            'XResolution': 'Xåˆ†è¾¨ç‡',
            'YResolution': 'Yåˆ†è¾¨ç‡',
            'Flash': 'é—ªå…‰ç¯',
            'FocalLength': 'ç„¦è·',
            'ExposureTime': 'æ›å…‰æ—¶é—´',
            'FNumber': 'å…‰åœˆå€¼',
            'ISO': 'ISOæ„Ÿå…‰åº¦',
            'ISOSpeedRatings': 'ISOé€Ÿåº¦',
            'LensModel': 'é•œå¤´å‹å·',
            'WhiteBalance': 'ç™½å¹³è¡¡',
            'è§†é¢‘å®½åº¦': 'è§†é¢‘å®½åº¦',
            'è§†é¢‘é«˜åº¦': 'è§†é¢‘é«˜åº¦',
            'æ—¶é•¿': 'è§†é¢‘æ—¶é•¿'
        };

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatDate(timestamp) {
            return new Date(timestamp).toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function formatGPS(gpsArray) {
            if (!gpsArray || gpsArray.length !== 3) return gpsArray;
            const [degrees, minutes, seconds] = gpsArray;
            return `${degrees}Â°${minutes}'${seconds.toFixed(2)}"`;
        }

        function formatDuration(seconds) {
            if (!seconds || isNaN(seconds)) return 'æœªçŸ¥';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function showStatus(type, message) {
            elements.status.className = `status ${type}`;
            elements.status.textContent = message;
        }

        function hideStatus() {
            elements.status.className = 'status';
            elements.status.textContent = '';
        }

        function showLoader() {
            elements.loader.classList.add('active');
        }

        function hideLoader() {
            elements.loader.classList.remove('active');
        }

        function updateProgress(percent) {
            elements.progressBar.classList.add('active');
            elements.progressFill.style.width = `${percent}%`;
        }

        function hideProgress() {
            elements.progressBar.classList.remove('active');
            elements.progressFill.style.width = '0%';
        }

        async function loadCaptcha() {
            try {
                const response = await fetch('https://v2.xxapi.cn/api/chineseCaptcha');
                const data = await response.json();

                if (data.code === 200 && data.data) {
                    state.captchaId = data.data.id;
                    elements.captchaImage.src = data.data.url;
                    elements.captchaError.classList.remove('active');
                } else {
                    throw new Error('éªŒè¯ç åŠ è½½å¤±è´¥');
                }
            } catch (error) {
                console.error('éªŒè¯ç åŠ è½½é”™è¯¯:', error);
                elements.captchaError.textContent = 'éªŒè¯ç åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•';
                elements.captchaError.classList.add('active');
            }
        }

        async function verifyCaptcha(answer) {
            try {
                const response = await fetch(`https://v2.xxapi.cn/api/chineseCaptcha?type=verify&id=${state.captchaId}&answer=${answer}`);
                const data = await response.json();

                return data.code === 200;
            } catch (error) {
                console.error('éªŒè¯ç éªŒè¯é”™è¯¯:', error);
                return false;
            }
        }

        function showCaptchaModal() {
            elements.captchaModal.classList.add('active');
            elements.captchaInput.value = '';
            elements.captchaError.classList.remove('active');
            loadCaptcha();
        }

        function hideCaptchaModal() {
            elements.captchaModal.classList.remove('active');
        }

        function handleFile(file) {
            if (!file) return;

            state.currentFile = file;
            state.processedBlob = null;
            state.captchaVerified = false;
            state.originalSize = file.size;
            elements.downloadBtn.disabled = true;

            elements.fileInfo.classList.add('active');
            elements.previewContainer.innerHTML = '';

            const fileType = file.type.split('/')[0];

            if (fileType === 'image') {
                const img = document.createElement('img');
                img.className = 'preview-image';
                img.src = URL.createObjectURL(file);
                img.onload = function() {
                    extractImageMetadata(img);
                };
                elements.previewContainer.appendChild(img);
            } else if (fileType === 'video') {
                const video = document.createElement('video');
                video.className = 'preview-video';
                video.src = URL.createObjectURL(file);
                video.controls = true;
                video.onloadedmetadata = function() {
                    extractVideoMetadata(video);
                };
                elements.previewContainer.appendChild(video);
            }

            displayFileDetails(file);
            hideStatus();
        }

        function displayFileDetails(file, processedSize = null) {
            const size = formatFileSize(file.size);
            const lastModified = formatDate(file.lastModified);

            let sizeComparisonHtml = '';
            if (processedSize !== null) {
                const reduction = ((file.size - processedSize) / file.size * 100).toFixed(1);
                const processedSizeStr = formatFileSize(processedSize);
                sizeComparisonHtml = `
                    <div class="size-comparison reduced">
                        âœ… å¤„ç†å: ${processedSizeStr} (å‡å°‘ ${reduction}%)
                    </div>
                `;
            }

            elements.fileDetails.innerHTML = `
                <div class="detail-item">
                    <div class="detail-label">ğŸ“„ æ–‡ä»¶å</div>
                    <div class="detail-value">${file.name}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">ğŸ’¾ æ–‡ä»¶å¤§å°</div>
                    <div class="detail-value">${size}</div>
                    ${sizeComparisonHtml}
                </div>
                <div class="detail-item">
                    <div class="detail-label">ğŸ“‹ æ–‡ä»¶ç±»å‹</div>
                    <div class="detail-value">${file.type || 'æœªçŸ¥'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">ğŸ• ä¿®æ”¹æ—¶é—´</div>
                    <div class="detail-value">${lastModified}</div>
                </div>
            `;
        }

        function extractImageMetadata(img) {
            EXIF.getData(img, function() {
                const allMetaData = EXIF.getAllTags(this);
                displayMetadata(allMetaData);
            });
        }

        function extractVideoMetadata(video) {
            const metadata = {
                'è§†é¢‘å®½åº¦': video.videoWidth + 'px',
                'è§†é¢‘é«˜åº¦': video.videoHeight + 'px',
                'æ—¶é•¿': formatDuration(video.duration)
            };
            displayMetadata(metadata);
        }

        function displayMetadata(metadata) {
            const keys = Object.keys(metadata).filter(k => metadata[k] !== undefined && metadata[k] !== '');

            if (keys.length === 0) {
                elements.metadataContainer.innerHTML = `
                    <div class="metadata-section" style="background: var(--success-bg); border-color: var(--success-color);">
                        <div class="no-metadata">
                            âœ… æœªæ£€æµ‹åˆ°å…ƒæ•°æ®ä¿¡æ¯
                        </div>
                    </div>
                `;
                state.hasMetadata = false;
                return;
            }

            state.hasMetadata = true;
            const metadataCount = keys.length;
            const hasGPS = metadata.GPSLatitude || metadata.GPSLongitude;
            const shouldCollapse = metadataCount > 6;

            let warningHtml = '';
            if (hasGPS || metadataCount > 0) {
                warningHtml = `
                    <div class="warning-box">
                        <div class="warning-icon">âš ï¸</div>
                        <div class="warning-text">
                            <strong>è­¦å‘Šï¼š</strong>æ­¤æ–‡ä»¶åŒ…å« <strong>${metadataCount}</strong> é¡¹å…ƒæ•°æ®${hasGPS ? 'ï¼Œ<strong>åŒ…æ‹¬GPSå®šä½ä¿¡æ¯ï¼</strong>' : 'ã€‚'}
                        </div>
                    </div>
                `;
            }

            let metadataHtml = '';
            for (let key of keys) {
                const displayName = metadataFields[key] || key;
                let value = metadata[key];

                if (key === 'GPSLatitude' || key === 'GPSLongitude') {
                    value = formatGPS(value);
                } else if (typeof value === 'object') {
                    value = JSON.stringify(value).substring(0, 50);
                }

                metadataHtml += `
                    <div class="metadata-item">
                        <span class="metadata-key">${displayName}</span>
                        <span class="metadata-value" title="${value}">${value}</span>
                    </div>
                `;
            }

            const toggleButton = shouldCollapse ? 
                `<button class="metadata-toggle" onclick="toggleMetadata(this)">å±•å¼€å…¨éƒ¨</button>` : '';

            elements.metadataContainer.innerHTML = `
                ${warningHtml}
                <div class="metadata-section">
                    <div class="metadata-header">
                        <span class="metadata-title">æ£€æµ‹åˆ°çš„å…ƒæ•°æ®</span>
                        <span class="metadata-badge">${metadataCount} é¡¹</span>
                        ${toggleButton}
                    </div>
                    <div class="metadata-list ${shouldCollapse ? 'collapsed' : ''}">
                        ${metadataHtml}
                    </div>
                </div>
            `;
        }

        window.toggleMetadata = function(button) {
            const list = button.closest('.metadata-section').querySelector('.metadata-list');
            if (list.classList.contains('collapsed')) {
                list.classList.remove('collapsed');
                list.classList.add('expanded');
                button.textContent = 'æ”¶èµ·';
            } else {
                list.classList.remove('expanded');
                list.classList.add('collapsed');
                button.textContent = 'å±•å¼€å…¨éƒ¨';
            }
        };

        async function processImage(file) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = function() {
                    try {
                        updateProgress(30);

                        const canvas = document.createElement('canvas');
                        canvas.width = img.width;
                        canvas.height = img.height;

                        updateProgress(50);

                        const ctx = canvas.getContext('2d', { 
                            alpha: file.type === 'image/png',
                            willReadFrequently: false
                        });

                        ctx.imageSmoothingEnabled = true;
                        ctx.imageSmoothingQuality = 'high';
                        ctx.drawImage(img, 0, 0);

                        updateProgress(70);

                        let outputType = file.type;
                        let quality = 0.92;

                        if (file.type === 'image/jpeg' || file.type === 'image/jpg') {
                            outputType = 'image/jpeg';
                            quality = 0.92;
                        } 
                        else if (file.type === 'image/png') {
                            outputType = 'image/png';
                            quality = 1.0;
                        }
                        else if (file.type === 'image/webp') {
                            outputType = 'image/webp';
                            quality = 0.92;
                        }
                        else if (file.type === 'image/gif') {
                            outputType = 'image/png';
                            quality = 1.0;
                        }
                        else {
                            outputType = 'image/jpeg';
                            quality = 0.92;
                        }

                        updateProgress(80);

                        canvas.toBlob(function(blob) {
                            if (blob) {
                                state.processedBlob = blob;
                                updateProgress(100);

                                console.log(`åŸå§‹: ${formatFileSize(file.size)}, å¤„ç†å: ${formatFileSize(blob.size)}`);

                                setTimeout(function() {
                                    hideProgress();
                                    resolve();
                                }, 500);
                            } else {
                                reject(new Error('æ— æ³•ç”Ÿæˆå¤„ç†åçš„å›¾ç‰‡'));
                            }
                        }, outputType, quality);
                    } catch (error) {
                        reject(error);
                    }
                };
                img.onerror = function() {
                    reject(new Error('æ— æ³•åŠ è½½å›¾ç‰‡'));
                };
                img.src = URL.createObjectURL(file);
            });
        }

        async function processVideo(file) {
            return new Promise((resolve, reject) => {
                updateProgress(30);

                const reader = new FileReader();
                reader.onload = function() {
                    state.processedBlob = new Blob([reader.result], { type: file.type });
                    updateProgress(100);
                    setTimeout(function() {
                        hideProgress();
                        resolve();
                    }, 500);
                };
                reader.onerror = function() {
                    reject(new Error('æ— æ³•è¯»å–è§†é¢‘æ–‡ä»¶'));
                };
                reader.readAsArrayBuffer(file);
            });
        }

        async function processFile() {
            if (!state.currentFile) return;
            showCaptchaModal();
        }

        async function doProcessFile() {
            showStatus('processing', 'â³ æ­£åœ¨æ¸…é™¤å…ƒæ•°æ®...');
            showLoader();
            elements.processBtn.disabled = true;

            try {
                const fileType = state.currentFile.type.split('/')[0];

                if (fileType === 'image') {
                    await processImage(state.currentFile);
                } else if (fileType === 'video') {
                    await processVideo(state.currentFile);
                }

                displayFileDetails(state.currentFile, state.processedBlob.size);

                const sizeReduction = ((state.originalSize - state.processedBlob.size) / state.originalSize * 100).toFixed(1);
                showStatus('success', `âœ… å…ƒæ•°æ®å·²æ¸…é™¤ï¼Œæ–‡ä»¶å¤§å°å‡å°‘ ${sizeReduction}%`);
                elements.downloadBtn.disabled = false;

                elements.metadataContainer.innerHTML = `
                    <div class="metadata-section" style="background: var(--success-bg); border-color: var(--success-color);">
                        <div class="no-metadata">
                            âœ… å…ƒæ•°æ®å·²å…¨éƒ¨æ¸…é™¤
                        </div>
                    </div>
                `;
            } catch (error) {
                showStatus('error', 'âŒ å¤„ç†å¤±è´¥ï¼š' + error.message);
                console.error('å¤„ç†é”™è¯¯:', error);
            } finally {
                hideLoader();
                elements.processBtn.disabled = false;
            }
        }

        function downloadFile() {
            if (!state.processedBlob) return;

            const url = URL.createObjectURL(state.processedBlob);
            const a = document.createElement('a');
            a.href = url;

            const originalName = state.currentFile.name;
            let extension = originalName.substring(originalName.lastIndexOf('.'));
            const nameWithoutExt = originalName.substring(0, originalName.lastIndexOf('.'));

            if (state.processedBlob.type === 'image/jpeg') {
                extension = '.jpg';
            } else if (state.processedBlob.type === 'image/png') {
                extension = '.png';
            } else if (state.processedBlob.type === 'image/webp') {
                extension = '.webp';
            }

            a.download = `${nameWithoutExt}_cleaned${extension}`;

            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showStatus('success', 'ğŸ“¥ æ–‡ä»¶å·²ä¸‹è½½');
        }

        function reset() {
            state.currentFile = null;
            state.processedBlob = null;
            state.captchaVerified = false;
            state.originalSize = 0;
            elements.fileInput.value = '';
            elements.fileInfo.classList.remove('active');
            elements.downloadBtn.disabled = true;
            elements.metadataContainer.innerHTML = '';
            hideStatus();
            hideProgress();
        }

        function init() {
            elements.uploadArea.addEventListener('click', function(e) {
                e.stopPropagation();
                elements.fileInput.click();
            });

            elements.fileInput.addEventListener('change', function(e) {
                if (e.target.files && e.target.files.length > 0) {
                    handleFile(e.target.files[0]);
                }
            });

            elements.uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.stopPropagation();
                elements.uploadArea.classList.add('dragover');
            });

            elements.uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                e.stopPropagation();
                elements.uploadArea.classList.remove('dragover');
            });

            elements.uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                elements.uploadArea.classList.remove('dragover');
                if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
                    handleFile(e.dataTransfer.files[0]);
                }
            });

            elements.processBtn.addEventListener('click', processFile);
            elements.downloadBtn.addEventListener('click', downloadFile);
            elements.resetBtn.addEventListener('click', reset);

            elements.captchaSubmit.addEventListener('click', async function() {
                const answer = elements.captchaInput.value.trim();
                if (!answer) {
                    elements.captchaError.textContent = 'è¯·è¾“å…¥éªŒè¯ç ';
                    elements.captchaError.classList.add('active');
                    return;
                }

                const isValid = await verifyCaptcha(answer);
                if (isValid) {
                    state.captchaVerified = true;
                    hideCaptchaModal();
                    doProcessFile();
                } else {
                    elements.captchaError.textContent = 'éªŒè¯ç é”™è¯¯ï¼Œè¯·é‡è¯•';
                    elements.captchaError.classList.add('active');
                    loadCaptcha();
                }
            });

            elements.captchaCancel.addEventListener('click', function() {
                hideCaptchaModal();
            });

            elements.captchaRefresh.addEventListener('click', function() {
                loadCaptcha();
            });

            elements.captchaInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    elements.captchaSubmit.click();
                }
            });

            elements.captchaModal.addEventListener('click', function(e) {
                if (e.target === elements.captchaModal) {
                    hideCaptchaModal();
                }
            });

            console.log('å…ƒæ•°æ®æ¸…é™¤å·¥å…·å·²åŠ è½½');
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
